<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <title>MNIST WebSocket Client</title>
        <style>
            body {
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            canvas {
                border: 2px solid #333;
                cursor: crosshair;
            }
            #preview {
                border: 1px solid red;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <h2>Dessinez un chiffre</h2>
        <canvas id="mainCanvas" width="280" height="280"></canvas>

        <canvas
            id="miniCanvas"
            width="28"
            height="28"
            style="display: none"
        ></canvas>

        <p>
            Prédiction :
            <span id="prediction" style="font-weight: bold; color: blue"
                >...</span
            >
        </p>
        <button onclick="clearCanvas()">Effacer</button>

        <script>
            const canvas = document.getElementById("mainCanvas");
            const ctx = canvas.getContext("2d");
            const miniCanvas = document.getElementById("miniCanvas");
            const miniCtx = miniCanvas.getContext("2d");

            const socket = new WebSocket("ws://127.0.0.1:8000");

            socket.binaryType = "arraybuffer"; // Important

            socket.onopen = () => console.log("Connecté au serveur C MNIST");
            socket.onmessage = (event) => {
                document.getElementById("prediction").innerText = event.data;
            };

            let drawing = false;
            ctx.lineWidth = 32;
            ctx.lineCap = "round";
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "white";

            canvas.addEventListener("mousedown", (e) => {
                drawing = true;
                ctx.beginPath();
                const rect = canvas.getBoundingClientRect();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });

            canvas.addEventListener("mouseup", () => {
                drawing = false;
            });

            canvas.addEventListener("mousemove", draw);

            function draw(e) {
                if (!drawing) return;

                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);

                sendData();
            }

            function clearCanvas() {
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                document.getElementById("prediction").innerText = "...";
            }

            function sendData() {
                if (socket.readyState !== WebSocket.OPEN) {
                    console.log(
                        "Error the socket isn't ready: ",
                        socket.readyState,
                    );
                    return;
                }

                miniCtx.drawImage(canvas, 0, 0, 28, 28);

                const imageData = miniCtx.getImageData(0, 0, 28, 28);
                const data = imageData.data; // [r, g, b, a, r, g, b, a...]

                const inputVector = new Uint8Array(784);

                for (let i = 0; i < 784; i++) {
                    inputVector[i] = data[i * 4]; // Only take 1 byte
                }

                socket.send(inputVector);
            }
        </script>
    </body>
</html>
